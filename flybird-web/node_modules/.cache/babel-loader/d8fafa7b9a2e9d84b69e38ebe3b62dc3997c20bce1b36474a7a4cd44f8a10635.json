{"ast":null,"code":"import { defineStore } from 'pinia';\nimport { auth } from '@/api/auth';\nimport request from '@/utils/request';\nimport router from '@/router';\nimport { useAccountStore } from '@/stores/account';\nimport { useUserStore } from '@/stores/user';\nexport const useAuthStore = defineStore('auth', {\n  state: () => ({\n    isLoggedIn: false,\n    rememberMe: false,\n    token: null,\n    refreshToken: null,\n    tokenExpiresAt: null\n  }),\n  actions: {\n    async login(credentials, rememberMe = false) {\n      try {\n        const response = await auth.loginWithPassword({\n          account: credentials.account.trim(),\n          password: credentials.password\n        });\n        if (response?.data?.code === 200) {\n          const {\n            access,\n            refresh\n          } = response.data.data;\n\n          // 存储认证信息\n          const expiresAt = new Date().getTime() + (rememberMe ? 7 : 1) * 24 * 60 * 60 * 1000;\n          this.token = access;\n          this.refreshToken = refresh;\n          this.tokenExpiresAt = expiresAt;\n          this.isLoggedIn = true;\n          this.rememberMe = rememberMe;\n\n          // 存储到 localStorage\n          localStorage.setItem('token', access);\n          localStorage.setItem('refresh_token', refresh);\n          localStorage.setItem('token_expires_at', expiresAt);\n          localStorage.setItem('remember_me', rememberMe);\n\n          // 设置请求头\n          request.defaults.headers.common['Authorization'] = `Bearer ${access}`;\n\n          // 记住账号\n          if (rememberMe) {\n            localStorage.setItem('remembered_account', credentials.account);\n          } else {\n            localStorage.removeItem('remembered_account');\n          }\n          return true;\n        }\n        return false;\n      } catch (error) {\n        console.error('Login failed:', error);\n        throw error;\n      }\n    },\n    async logout() {\n      try {\n        if (this.refreshToken) {\n          await auth.logout();\n        }\n      } finally {\n        this.clearAuth();\n        const accountStore = useAccountStore();\n        const userStore = useUserStore();\n        accountStore.clearUserInfo();\n        userStore.clearUserInfo();\n\n        // 清除所有相关的 localStorage 数据\n        const keysToRemove = ['token', 'refresh_token', 'token_expires_at', 'remember_me', 'remembered_account', 'userInfo', 'isLoggedIn', 'avatarUpdateTime', 'backgroundImage'\n        // 添加其他可能存在的 key\n        ];\n        keysToRemove.forEach(key => {\n          localStorage.removeItem(key);\n        });\n        router.push('/login');\n      }\n    },\n    clearAuth() {\n      // 清除请求头\n      delete request.defaults.headers.common['Authorization'];\n\n      // 重置状态\n      this.isLoggedIn = false;\n      this.token = null;\n      this.refreshToken = null;\n      this.tokenExpiresAt = null;\n      this.rememberMe = false;\n    },\n    // 检查 token 是否过期\n    isTokenExpired() {\n      return !this.tokenExpiresAt || new Date().getTime() > this.tokenExpiresAt;\n    },\n    // 从 localStorage 恢复认证状态\n    restoreAuth() {\n      const token = localStorage.getItem('token');\n      const refreshToken = localStorage.getItem('refresh_token');\n      const tokenExpiresAt = localStorage.getItem('token_expires_at');\n      const rememberMe = localStorage.getItem('remember_me') === 'true';\n      if (token && refreshToken && tokenExpiresAt) {\n        this.token = token;\n        this.refreshToken = refreshToken;\n        this.tokenExpiresAt = parseInt(tokenExpiresAt);\n        this.rememberMe = rememberMe;\n        this.isLoggedIn = !this.isTokenExpired();\n        if (this.isLoggedIn) {\n          request.defaults.headers.common['Authorization'] = `Bearer ${token}`;\n        }\n      }\n    }\n  }\n});","map":{"version":3,"names":["defineStore","auth","request","router","useAccountStore","useUserStore","useAuthStore","state","isLoggedIn","rememberMe","token","refreshToken","tokenExpiresAt","actions","login","credentials","response","loginWithPassword","account","trim","password","data","code","access","refresh","expiresAt","Date","getTime","localStorage","setItem","defaults","headers","common","removeItem","error","console","logout","clearAuth","accountStore","userStore","clearUserInfo","keysToRemove","forEach","key","push","isTokenExpired","restoreAuth","getItem","parseInt"],"sources":["/Users/liuzhao/Documents/Projects/flybird/flybird-web/src/stores/auth.js"],"sourcesContent":["import { defineStore } from 'pinia'\nimport { auth } from '@/api/auth'\nimport request from '@/utils/request'\nimport router from '@/router'\nimport { useAccountStore } from '@/stores/account'\nimport { useUserStore } from '@/stores/user'\n\nexport const useAuthStore = defineStore('auth', {\n  state: () => ({\n    isLoggedIn: false,\n    rememberMe: false,\n    token: null,\n    refreshToken: null,\n    tokenExpiresAt: null\n  }),\n\n  actions: {\n    async login(credentials, rememberMe = false) {\n      try {\n        const response = await auth.loginWithPassword({\n          account: credentials.account.trim(),\n          password: credentials.password\n        })\n        \n        if (response?.data?.code === 200) {\n          const { access, refresh } = response.data.data\n          \n          // 存储认证信息\n          const expiresAt = new Date().getTime() + (rememberMe ? 7 : 1) * 24 * 60 * 60 * 1000\n          \n          this.token = access\n          this.refreshToken = refresh\n          this.tokenExpiresAt = expiresAt\n          this.isLoggedIn = true\n          this.rememberMe = rememberMe\n          \n          // 存储到 localStorage\n          localStorage.setItem('token', access)\n          localStorage.setItem('refresh_token', refresh)\n          localStorage.setItem('token_expires_at', expiresAt)\n          localStorage.setItem('remember_me', rememberMe)\n          \n          // 设置请求头\n          request.defaults.headers.common['Authorization'] = `Bearer ${access}`\n          \n          // 记住账号\n          if (rememberMe) {\n            localStorage.setItem('remembered_account', credentials.account)\n          } else {\n            localStorage.removeItem('remembered_account')\n          }\n          \n          return true\n        }\n        return false\n      } catch (error) {\n        console.error('Login failed:', error)\n        throw error\n      }\n    },\n\n    async logout() {\n      try {\n        if (this.refreshToken) {\n          await auth.logout()\n        }\n      } finally {\n        this.clearAuth()\n        const accountStore = useAccountStore()\n        const userStore = useUserStore()\n        accountStore.clearUserInfo()\n        userStore.clearUserInfo()\n        \n        // 清除所有相关的 localStorage 数据\n        const keysToRemove = [\n          'token',\n          'refresh_token',\n          'token_expires_at',\n          'remember_me',\n          'remembered_account',\n          'userInfo',\n          'isLoggedIn',\n          'avatarUpdateTime',\n          'backgroundImage',\n          // 添加其他可能存在的 key\n        ]\n        \n        keysToRemove.forEach(key => {\n          localStorage.removeItem(key)\n        })\n        \n        router.push('/login')\n      }\n    },\n\n    clearAuth() {\n      // 清除请求头\n      delete request.defaults.headers.common['Authorization']\n      \n      // 重置状态\n      this.isLoggedIn = false\n      this.token = null\n      this.refreshToken = null\n      this.tokenExpiresAt = null\n      this.rememberMe = false\n    },\n\n    // 检查 token 是否过期\n    isTokenExpired() {\n      return !this.tokenExpiresAt || new Date().getTime() > this.tokenExpiresAt\n    },\n\n    // 从 localStorage 恢复认证状态\n    restoreAuth() {\n      const token = localStorage.getItem('token')\n      const refreshToken = localStorage.getItem('refresh_token')\n      const tokenExpiresAt = localStorage.getItem('token_expires_at')\n      const rememberMe = localStorage.getItem('remember_me') === 'true'\n\n      if (token && refreshToken && tokenExpiresAt) {\n        this.token = token\n        this.refreshToken = refreshToken\n        this.tokenExpiresAt = parseInt(tokenExpiresAt)\n        this.rememberMe = rememberMe\n        this.isLoggedIn = !this.isTokenExpired()\n        \n        if (this.isLoggedIn) {\n          request.defaults.headers.common['Authorization'] = `Bearer ${token}`\n        }\n      }\n    }\n  }\n}) "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}