{"ast":null,"code":"import { defineStore } from 'pinia';\nimport { auth } from '@/api/auth';\nimport request from '@/utils/request';\nimport router from '@/router';\nimport { useAccountStore } from '@/stores/account';\nimport { useUserStore } from '@/stores/user';\nexport const useAuthStore = defineStore('auth', {\n  state: () => ({\n    isLoggedIn: false,\n    rememberMe: false,\n    token: null,\n    refreshToken: null,\n    tokenExpiresAt: null\n  }),\n  actions: {\n    async login(credentials, rememberMe = false) {\n      try {\n        const response = await auth.loginWithPassword(credentials);\n        if (response) {\n          // 保存 token\n          this.token = response.token;\n          this.refreshToken = response.refresh;\n          localStorage.setItem('token', response.token);\n          localStorage.setItem('refresh_token', response.refresh);\n\n          // 设置请求头\n          request.defaults.headers.common['Authorization'] = `Bearer ${response.token}`;\n\n          // 设置登录状态\n          this.isLoggedIn = true;\n\n          // 登录成功后立即获取用户信息并存储\n          const accountStore = useAccountStore();\n          await accountStore.fetchUserInfo();\n\n          // 记住账号功能\n          if (rememberMe) {\n            localStorage.setItem('remember_me', 'true');\n            localStorage.setItem('remembered_account', credentials.account);\n          }\n          return true;\n        }\n        return false;\n      } catch (error) {\n        console.error('Login failed:', error);\n        throw error;\n      }\n    },\n    async logout() {\n      try {\n        if (this.refreshToken) {\n          await auth.logout();\n        }\n      } finally {\n        this.clearAuth();\n        const accountStore = useAccountStore();\n        const userStore = useUserStore();\n        accountStore.clearUserInfo();\n        userStore.clearUserInfo();\n\n        // 清除所有相关的 localStorage 数据\n        const keysToRemove = ['token', 'refresh_token', 'token_expires_at', 'remember_me', 'remembered_account', 'userInfo', 'isLoggedIn', 'avatarUpdateTime', 'backgroundImage'\n        // 添加其他可能存在的 key\n        ];\n        keysToRemove.forEach(key => {\n          localStorage.removeItem(key);\n        });\n        router.push('/login');\n      }\n    },\n    clearAuth() {\n      // 清除请求头\n      delete request.defaults.headers.common['Authorization'];\n\n      // 重置状态\n      this.isLoggedIn = false;\n      this.token = null;\n      this.refreshToken = null;\n      this.tokenExpiresAt = null;\n      this.rememberMe = false;\n    },\n    // 检查 token 是否过期\n    isTokenExpired() {\n      return !this.tokenExpiresAt || new Date().getTime() > this.tokenExpiresAt;\n    },\n    // 从 localStorage 恢复认证状态\n    restoreAuth() {\n      const token = localStorage.getItem('token');\n      const refreshToken = localStorage.getItem('refresh_token');\n      const tokenExpiresAt = localStorage.getItem('token_expires_at');\n      const rememberMe = localStorage.getItem('remember_me') === 'true';\n      if (token && refreshToken && tokenExpiresAt) {\n        this.token = token;\n        this.refreshToken = refreshToken;\n        this.tokenExpiresAt = parseInt(tokenExpiresAt);\n        this.rememberMe = rememberMe;\n        this.isLoggedIn = !this.isTokenExpired();\n        if (this.isLoggedIn) {\n          request.defaults.headers.common['Authorization'] = `Bearer ${token}`;\n        }\n      }\n    }\n  }\n});","map":{"version":3,"names":["defineStore","auth","request","router","useAccountStore","useUserStore","useAuthStore","state","isLoggedIn","rememberMe","token","refreshToken","tokenExpiresAt","actions","login","credentials","response","loginWithPassword","refresh","localStorage","setItem","defaults","headers","common","accountStore","fetchUserInfo","account","error","console","logout","clearAuth","userStore","clearUserInfo","keysToRemove","forEach","key","removeItem","push","isTokenExpired","Date","getTime","restoreAuth","getItem","parseInt"],"sources":["/Users/liuzhao/Documents/Projects/flybird/flybird-web/src/stores/auth.js"],"sourcesContent":["import { defineStore } from 'pinia'\nimport { auth } from '@/api/auth'\nimport request from '@/utils/request'\nimport router from '@/router'\nimport { useAccountStore } from '@/stores/account'\nimport { useUserStore } from '@/stores/user'\n\nexport const useAuthStore = defineStore('auth', {\n  state: () => ({\n    isLoggedIn: false,\n    rememberMe: false,\n    token: null,\n    refreshToken: null,\n    tokenExpiresAt: null\n  }),\n\n  actions: {\n    async login(credentials, rememberMe = false) {\n      try {\n        const response = await auth.loginWithPassword(credentials)\n        if (response) {\n          // 保存 token\n          this.token = response.token\n          this.refreshToken = response.refresh\n          localStorage.setItem('token', response.token)\n          localStorage.setItem('refresh_token', response.refresh)\n          \n          // 设置请求头\n          request.defaults.headers.common['Authorization'] = `Bearer ${response.token}`\n          \n          // 设置登录状态\n          this.isLoggedIn = true\n          \n          // 登录成功后立即获取用户信息并存储\n          const accountStore = useAccountStore()\n          await accountStore.fetchUserInfo()\n          \n          // 记住账号功能\n          if (rememberMe) {\n            localStorage.setItem('remember_me', 'true')\n            localStorage.setItem('remembered_account', credentials.account)\n          }\n          \n          return true\n        }\n        return false\n      } catch (error) {\n        console.error('Login failed:', error)\n        throw error\n      }\n    },\n\n    async logout() {\n      try {\n        if (this.refreshToken) {\n          await auth.logout()\n        }\n      } finally {\n        this.clearAuth()\n        const accountStore = useAccountStore()\n        const userStore = useUserStore()\n        accountStore.clearUserInfo()\n        userStore.clearUserInfo()\n        \n        // 清除所有相关的 localStorage 数据\n        const keysToRemove = [\n          'token',\n          'refresh_token',\n          'token_expires_at',\n          'remember_me',\n          'remembered_account',\n          'userInfo',\n          'isLoggedIn',\n          'avatarUpdateTime',\n          'backgroundImage',\n          // 添加其他可能存在的 key\n        ]\n        \n        keysToRemove.forEach(key => {\n          localStorage.removeItem(key)\n        })\n        \n        router.push('/login')\n      }\n    },\n\n    clearAuth() {\n      // 清除请求头\n      delete request.defaults.headers.common['Authorization']\n      \n      // 重置状态\n      this.isLoggedIn = false\n      this.token = null\n      this.refreshToken = null\n      this.tokenExpiresAt = null\n      this.rememberMe = false\n    },\n\n    // 检查 token 是否过期\n    isTokenExpired() {\n      return !this.tokenExpiresAt || new Date().getTime() > this.tokenExpiresAt\n    },\n\n    // 从 localStorage 恢复认证状态\n    restoreAuth() {\n      const token = localStorage.getItem('token')\n      const refreshToken = localStorage.getItem('refresh_token')\n      const tokenExpiresAt = localStorage.getItem('token_expires_at')\n      const rememberMe = localStorage.getItem('remember_me') === 'true'\n\n      if (token && refreshToken && tokenExpiresAt) {\n        this.token = token\n        this.refreshToken = refreshToken\n        this.tokenExpiresAt = parseInt(tokenExpiresAt)\n        this.rememberMe = rememberMe\n        this.isLoggedIn = !this.isTokenExpired()\n        \n        if (this.isLoggedIn) {\n          request.defaults.headers.common['Authorization'] = `Bearer ${token}`\n        }\n      }\n    }\n  }\n}) "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}