{"ast":null,"code":"import { createCommentVNode as _createCommentVNode, createElementVNode as _createElementVNode, createTextVNode as _createTextVNode, resolveComponent as _resolveComponent, withCtx as _withCtx, createVNode as _createVNode, openBlock as _openBlock, createElementBlock as _createElementBlock, createBlock as _createBlock } from \"vue\";\nconst _hoisted_1 = {\n  class: \"avatar-upload-container\"\n};\nconst _hoisted_2 = {\n  key: 0,\n  class: \"upload-btn\"\n};\nconst _hoisted_3 = {\n  class: \"dialog-footer\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  const _component_el_button = _resolveComponent(\"el-button\");\n  const _component_el_dialog = _resolveComponent(\"el-dialog\");\n  return _openBlock(), _createBlock(_component_el_dialog, {\n    modelValue: $setup.visible,\n    \"onUpdate:modelValue\": _cache[1] || (_cache[1] = $event => $setup.visible = $event),\n    title: \"上传头像\",\n    width: \"500px\",\n    \"close-on-click-modal\": false,\n    \"close-on-press-escape\": false\n  }, {\n    footer: _withCtx(() => [_createElementVNode(\"div\", _hoisted_3, [_createVNode(_component_el_button, {\n      onClick: $setup.handleCancel\n    }, {\n      default: _withCtx(() => _cache[3] || (_cache[3] = [_createTextVNode(\"取消\")])),\n      _: 1 /* STABLE */\n    }), $setup.cropImg ? (_openBlock(), _createBlock(_component_el_button, {\n      key: 0,\n      onClick: $setup.handleReselect\n    }, {\n      default: _withCtx(() => _cache[4] || (_cache[4] = [_createTextVNode(\"重新选择\")])),\n      _: 1 /* STABLE */\n    })) : _createCommentVNode(\"v-if\", true), _createVNode(_component_el_button, {\n      type: \"primary\",\n      onClick: $setup.handleConfirm,\n      loading: $setup.uploading\n    }, {\n      default: _withCtx(() => _cache[5] || (_cache[5] = [_createTextVNode(\" 确认上传 \")])),\n      _: 1 /* STABLE */\n    }, 8 /* PROPS */, [\"loading\"])])]),\n    default: _withCtx(() => [_createElementVNode(\"div\", _hoisted_1, [_createCommentVNode(\" 上传按钮 \"), !$setup.cropImg ? (_openBlock(), _createElementBlock(\"div\", _hoisted_2, [_createElementVNode(\"input\", {\n      type: \"file\",\n      ref: \"fileInput\",\n      accept: \"image/*\",\n      onChange: $setup.handleSelectImage,\n      style: {\n        \"display\": \"none\"\n      }\n    }, null, 544 /* NEED_HYDRATION, NEED_PATCH */), _createVNode(_component_el_button, {\n      type: \"primary\",\n      onClick: _cache[0] || (_cache[0] = $event => _ctx.$refs.fileInput.click())\n    }, {\n      default: _withCtx(() => _cache[2] || (_cache[2] = [_createTextVNode(\" 选择图片 \")])),\n      _: 1 /* STABLE */\n    })])) : _createCommentVNode(\"v-if\", true), _createCommentVNode(\" 图片裁剪组件 \"), $setup.cropImg ? (_openBlock(), _createBlock($setup[\"VueCropper\"], {\n      key: 1,\n      ref: \"cropperRef\",\n      img: $setup.cropImg,\n      info: true,\n      autoCrop: true,\n      fixedBox: true,\n      centerBox: true,\n      fixed: true,\n      fixedNumber: [1, 1],\n      canScale: false,\n      full: false,\n      outputType: 'png',\n      onRealTime: $setup.cropImage\n    }, null, 8 /* PROPS */, [\"img\"])) : _createCommentVNode(\"v-if\", true)])]),\n    _: 1 /* STABLE */\n  }, 8 /* PROPS */, [\"modelValue\"]);\n}","map":{"version":3,"names":["class","key","_createBlock","_component_el_dialog","modelValue","$setup","visible","_cache","$event","title","width","footer","_withCtx","_createElementVNode","_hoisted_3","_createVNode","_component_el_button","onClick","handleCancel","default","_createTextVNode","_","cropImg","handleReselect","_createCommentVNode","type","handleConfirm","loading","uploading","_hoisted_1","_createElementBlock","_hoisted_2","ref","accept","onChange","handleSelectImage","style","_ctx","$refs","fileInput","click","img","info","autoCrop","fixedBox","centerBox","fixed","fixedNumber","canScale","full","outputType","onRealTime","cropImage"],"sources":["/Users/liuzhao/Documents/Projects/flybird/flybird-web/src/views/user/MyProfile/dialogs/AvatarUploadDialog.vue"],"sourcesContent":["<template>\n  <el-dialog\n    v-model=\"visible\"\n    title=\"上传头像\"\n    width=\"500px\"\n    :close-on-click-modal=\"false\"\n    :close-on-press-escape=\"false\"\n  >\n    <div class=\"avatar-upload-container\">\n      <!-- 上传按钮 -->\n      <div class=\"upload-btn\" v-if=\"!cropImg\">\n        <input\n          type=\"file\"\n          ref=\"fileInput\"\n          accept=\"image/*\"\n          @change=\"handleSelectImage\"\n          style=\"display: none\"\n        />\n        <el-button type=\"primary\" @click=\"$refs.fileInput.click()\">\n          选择图片\n        </el-button>\n      </div>\n      \n      <!-- 图片裁剪组件 -->\n      <vue-cropper v-if=\"cropImg\"\n        ref=\"cropperRef\"\n        :img=\"cropImg\"\n        :info=\"true\"\n        :autoCrop=\"true\"\n        :fixedBox=\"true\"\n        :centerBox=\"true\"\n        :fixed=\"true\"\n        :fixedNumber=\"[1, 1]\"\n        :canScale=\"false\"\n        :full=\"false\"\n        :outputType=\"'png'\"\n        @realTime=\"cropImage\"\n      />\n    </div>\n    <template #footer>\n      <div class=\"dialog-footer\">\n        <el-button @click=\"handleCancel\">取消</el-button>\n        <el-button v-if=\"cropImg\" @click=\"handleReselect\">重新选择</el-button>\n        <el-button type=\"primary\" @click=\"handleConfirm\" :loading=\"uploading\">\n          确认上传\n        </el-button>\n      </div>\n    </template>\n  </el-dialog>\n</template>\n\n<script setup>\nimport { ref, computed } from 'vue'\nimport { VueCropper } from 'vue-cropper'\nimport 'vue-cropper/dist/index.css'\nimport { useAccountStore } from '@/stores/account'\nimport profile from '@/api/profile'\nimport { showToast } from '@/components/ToastMessage'\n\nconst props = defineProps({\n  modelValue: Boolean\n})\n\nconst emit = defineEmits(['update:modelValue', 'success'])\n\nconst visible = computed({\n  get: () => props.modelValue,\n  set: (val) => emit('update:modelValue', val)\n})\n\nconst accountStore = useAccountStore()\nconst cropperRef = ref(null)\nconst cropImg = ref('')\nconst uploading = ref(false)\nconst fileInput = ref(null)\n\n// 选择图片\nconst handleSelectImage = (e) => {\n  const file = e.target.files[0]\n  if (!file) return\n  \n  if (!file.type.includes('image/')) {\n    showToast('请选择图片文件', 'warning')\n    return\n  }\n  \n  const reader = new FileReader()\n  reader.onload = (e) => {\n    cropImg.value = e.target.result\n  }\n  reader.readAsDataURL(file)\n}\n\n// 裁剪图片\nconst cropImage = () => {\n  // 实时预览\n}\n\n// 上传裁剪后的图片\nconst handleCropUpload = async () => {\n  try {\n    uploading.value = true\n    // 获取裁剪后的图片 blob 数据\n    const blob = await new Promise((resolve) => {\n      cropperRef.value.getCropBlob((data) => {\n        resolve(data)\n      })\n    })\n    \n    // 确保文件类型是 image/png\n    const file = new File([blob], 'avatar.png', {\n      type: 'image/png'\n    })\n    \n    // 构建 FormData\n    const formData = new FormData()\n    formData.append('avatar', file)\n    \n    const response = await profile.uploadAvatar(formData)\n    \n    if (response?.data?.code === 200) {\n      // 更新 store 中的用户信息\n      await accountStore.fetchUserInfo()\n      \n      showToast('头像上传成功', 'success')\n      // 强制更新头像时间戳，触发重新渲染\n      accountStore.avatarUpdateTime = Date.now()\n      \n      emit('success')\n      visible.value = false\n    }\n  } catch (error) {\n    console.error('头像上传失败:', error)\n    if (error.response) {\n      console.error('Error response:', {\n        status: error.response.status,\n        data: error.response.data,\n        headers: error.response.headers\n      })\n    }\n    showToast(error.response?.data?.message || '头像上传失败', 'error')\n  } finally {\n    uploading.value = false\n  }\n}\n\n// 重新选择图片\nconst handleReselect = () => {\n  cropImg.value = ''\n  fileInput.value.value = '' // 清空文件输入\n}\n\n// 取消\nconst handleCancel = () => {\n  cropImg.value = ''\n  fileInput.value.value = ''\n  visible.value = false\n}\n\n// 确认上传\nconst handleConfirm = () => {\n  if (!cropImg.value) {\n    showToast('请先选择图片', 'warning')\n    return\n  }\n  handleCropUpload()\n}\n</script>\n\n<style scoped>\n.avatar-upload-container {\n  width: 100%;\n  height: 400px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.upload-btn {\n  text-align: center;\n}\n\n.cropper {\n  width: 100%;\n  height: 100%;\n}\n\n.dialog-footer {\n  display: flex;\n  justify-content: flex-end;\n  gap: 12px;\n  padding-top: 20px;\n}\n</style> "],"mappings":";;EAQSA,KAAK,EAAC;AAAyB;;EARxCC,GAAA;EAUWD,KAAK,EAAC;;;EA8BNA,KAAK,EAAC;AAAe;;;;uBAvC9BE,YAAA,CA+CYC,oBAAA;IAhDdC,UAAA,EAEaC,MAAA,CAAAC,OAAO;IAFpB,uBAAAC,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAEaH,MAAA,CAAAC,OAAO,GAAAE,MAAA;IAChBC,KAAK,EAAC,MAAM;IACZC,KAAK,EAAC,OAAO;IACZ,sBAAoB,EAAE,KAAK;IAC3B,uBAAqB,EAAE;;IAiCbC,MAAM,EAAAC,QAAA,CACf,MAMM,CANNC,mBAAA,CAMM,OANNC,UAMM,GALJC,YAAA,CAA+CC,oBAAA;MAAnCC,OAAK,EAAEZ,MAAA,CAAAa;IAAY;MAzCvCC,OAAA,EAAAP,QAAA,CAyCyC,MAAEL,MAAA,QAAAA,MAAA,OAzC3Ca,gBAAA,CAyCyC,IAAE,E;MAzC3CC,CAAA;QA0CyBhB,MAAA,CAAAiB,OAAO,I,cAAxBpB,YAAA,CAAkEc,oBAAA;MA1C1Ef,GAAA;MA0CmCgB,OAAK,EAAEZ,MAAA,CAAAkB;;MA1C1CJ,OAAA,EAAAP,QAAA,CA0C0D,MAAIL,MAAA,QAAAA,MAAA,OA1C9Da,gBAAA,CA0C0D,MAAI,E;MA1C9DC,CAAA;UAAAG,mBAAA,gBA2CQT,YAAA,CAEYC,oBAAA;MAFDS,IAAI,EAAC,SAAS;MAAER,OAAK,EAAEZ,MAAA,CAAAqB,aAAa;MAAGC,OAAO,EAAEtB,MAAA,CAAAuB;;MA3CnET,OAAA,EAAAP,QAAA,CA2C8E,MAEtEL,MAAA,QAAAA,MAAA,OA7CRa,gBAAA,CA2C8E,QAEtE,E;MA7CRC,CAAA;;IAAAF,OAAA,EAAAP,QAAA,CAQI,MA8BM,CA9BNC,mBAAA,CA8BM,OA9BNgB,UA8BM,GA7BJL,mBAAA,UAAa,E,CACkBnB,MAAA,CAAAiB,OAAO,I,cAAtCQ,mBAAA,CAWM,OAXNC,UAWM,GAVJlB,mBAAA,CAME;MALAY,IAAI,EAAC,MAAM;MACXO,GAAG,EAAC,WAAW;MACfC,MAAM,EAAC,SAAS;MACfC,QAAM,EAAE7B,MAAA,CAAA8B,iBAAiB;MAC1BC,KAAqB,EAArB;QAAA;MAAA;oDAEFrB,YAAA,CAEYC,oBAAA;MAFDS,IAAI,EAAC,SAAS;MAAER,OAAK,EAAAV,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAAE6B,IAAA,CAAAC,KAAK,CAACC,SAAS,CAACC,KAAK;;MAlB/DrB,OAAA,EAAAP,QAAA,CAkBmE,MAE3DL,MAAA,QAAAA,MAAA,OApBRa,gBAAA,CAkBmE,QAE3D,E;MApBRC,CAAA;YAAAG,mBAAA,gBAuBMA,mBAAA,YAAe,EACInB,MAAA,CAAAiB,OAAO,I,cAA1BpB,YAAA,CAaEG,MAAA;MArCRJ,GAAA;MAyBQ+B,GAAG,EAAC,YAAY;MACfS,GAAG,EAAEpC,MAAA,CAAAiB,OAAO;MACZoB,IAAI,EAAE,IAAI;MACVC,QAAQ,EAAE,IAAI;MACdC,QAAQ,EAAE,IAAI;MACdC,SAAS,EAAE,IAAI;MACfC,KAAK,EAAE,IAAI;MACXC,WAAW,EAAE,MAAM;MACnBC,QAAQ,EAAE,KAAK;MACfC,IAAI,EAAE,KAAK;MACXC,UAAU,EAAE,KAAK;MACjBC,UAAQ,EAAE9C,MAAA,CAAA+C;wCApCnB5B,mBAAA,e;IAAAH,CAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}